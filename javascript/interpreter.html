<!DOCTYPE html>
<html>
<head>
	<title>Fourier Interpreter</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
	<style>
		body {
			padding-left: 2em;
			background-color: gainsboro
		}
        
		thead {
			display: block;
			position: relative
		}
		
		tbody {
			display: block;
			overflow-y: scroll;
			overflow-x:hidden;
			height:500px;
		}
		
		tr:first-child th {
			min-width: 100px;
		}
		
		tr:last-child th {
			min-width: 350px
		}
		
		tr:first-child td {
			min-width: 100px;
		}
		
		tr:last-child td {
			min-width: 300px
		}
		
		
		table {
			width: 700px;
			table-layout: fixed
		}
		
        table, th, td {
            padding: 10px;
        }

        td {
            background-color: #DBAFAF;
            font-family: Courier New;
			border-bottom: 1px solid #e2bfbf
        }

        textarea, input {
            font-family: Courier New;
			border: none
        }

        th {
            background-color: #DB8484;
            border-bottom: 1px solid black;
            text-weight: bold
        }
	</style>
</head>
<body>
	<h1><a href="http://esolangs.org/wiki/Fourier">Fourier</a> Interpreter</h1>
	<h3>Code:</h3>
	<textarea id="code" rows="4" oninput="javascript:chars()" cols="40"></textarea>
    <br/>
    <button id="run" onclick="javascript:main()">Run</button>
    <button id="clear" onclick="javascript:clearText()">Clear</button>
    <br/>
    Character count: <span id="ccount">0</span> characters
    <h3>Output:</h3>
    <textarea id="output" readonly="readonly" rows="4" cols="40" style="cursor: default;"></textarea>
	<br/>
	<a href="javascript:getperma()">Get permalink</a>
	<br/>
	<h3>Character reference</h3>
        <h4>ASCII code reference</h4>
	<input id="charRef" cols="40" oninput="javascript:getCharCode()">
	<br/>
	<input id="asciiRef" readonly="readonly" cols="40" style="background-color: #c2c2c2; cursor: default;">
	<h4>Built-in Functions</h4>
		<table>
			<thead>
				<tr>
					<th>Character</th>
					<th>Function</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td>^</td>
					<td>Increments the accumulator</td>
				</tr>
				<tr>
					<td>v</td>
					<td>Decrements the accumulator</td>
				</tr>
				<tr>
					<td>x()</td>
					<td>Repeat the code within the brackets until the accumulator equals the value of the accumulator at x. After the open bracket, the accumulator is set to 0. Repeats can be nested.</td>
				</tr>
				<tr>
					<td>x{a}{b}</td>
					<td>If the result of a equals the value of the accumulator at x then run code b. After the open curly bracket, the accumulator is set to 0. Ifs cannot be nested.</td>
				</tr>
				<tr>
					<td>|a|x</td>
					<td>IN BETA: Creates a function x. When x is called, it runs the code a</td>
				</tr>
				<tr>
					<td>n</td>
					<td>Set the accumulator to the integer n.</td>
				</tr>
				<tr>
					<td>a</td>
					<td>Takes the value of the accumulator as the ASCII code and outputs the character. </td>
				</tr>
				<tr>
					<td>o</td>
					<td>Outputs the value of the accumulator.</td>
				<tr>
					<td>r</td>
					<td>Sets the accumulator to a random value in the range 0 to the value of the accumulator.</td>
				</tr>
				<tr>
					<td>~z</td>
					<td>Creates a variable z and sets it to value of the accumulator. </td>
				</tr>
				<tr>
					<td>z</td>
					<td>Sets the accumulator to the value of variable z. If not previously initialised, the variable is equal to 0.</td>
				</tr>
				<tr>
					<td>+x</td>
					<td>Sets the accumulator to the value of the accumulator plus the value of x.</td>
				</tr>
				<tr>
					<td>-x</td>
					<td>Sets the accumulator to the value of the accumulator minus the value of x.</td>
				</tr>
				<tr>
					<td>*x</td>
					<td>Sets the accumulator to the value of the accumulator multiplied by the value of x. </td>
				</tr>
				<tr>
					<td>/x</td>
					<td>Sets the accumulator to the value of the accumulator divided by the value of x.</td>
				</tr>
				<tr>
					<td>%x</td>
					<td>Sets the accumulator to the remainder of the accumulator divided by the value of x.</td>
				</tr>
				<tr>
					<td>I</td>
					<td>Sets the accumulator to the user input.</td>
				</tr>
				<tr>
					<td>>x</td>
					<td>Sets the accumulator to 1 if the value of the accumulator is greater than the value of x, 0 if not.</td>
				</tr>
				<tr>
					<td><x</td>
					<td>Sets the accumulator to 1 if the value of the accumulator is less than the value of x, 0 if not.</td>
				</tr>
				<tr>
					<td>=x</td>
					<td>Sets the accumulator to 1 if the value of the accumulator is equal to the value of x, 0 if not.</td>
				</tr>
				<tr>
					<td>xd</td>
					<td>Sets the accumulator to parts of the date depending on the value of x:
						<br/><br/>
						<ol start="0">
							<li>Sets the accumulator to the seconds part of the current time.</li>
							<li>Sets the accumulator to the minutes part of the current time.</li>
							<li>Sets the accumulator to the hours part of the current time.</li>
							<li>Sets the accumulator to the day part of the current date.</li>
							<li>Sets the accumulator to the month part of the current date.</li>
							<li>Sets the accumulator to the year part of the current date.</li>
						</ol>
						If the date is any other number (apart from 0, 1, 2, 3, 4, or 5), the accumulator is set to the current UNIX timestamp.
					</td>
				</tr>
				<tr>
					<td>@</td>
					<td>Clears the current output.</td>
				</tr>
				<tr>
					<td>x;</td>
					<td>Starts a time delay of x seconds, during which, no code is executed.</td>
				</tr>
			</tbody>
		</table>
		<br/>
		Also check out <strong><a href="http://fourier.tryitonline.net">Try it Online!</a></strong>
		<br/>
		<sub>Fourier was created by Stack Exchange user <a href="http://codegolf.stackexchange.com/users/30525">Beta Decay</a></sub>
		<br/><br/>
        <script>
		function getCharCode() {
			var chr = document.getElementById("charRef").value.charCodeAt(0);
			document.getElementById("asciiRef").value = chr||"";
		}

		function decode(string) {
			return decodeURIComponent(escape(atob(unescape(string).replace(/-/g, "+").replace(/_/g, "/"))))
		}

		function encode(string) {
			return btoa(unescape(encodeURIComponent(string))).replace(/\+/g, "-").replace(/\//g, "_").replace(/=/g, "")
		}


		function getperma() {
			var lcode = document.getElementById("code").value;
			var link = location.protocol + '//' + location.host + location.pathname + "?code=" + encode(lcode);
			
			window.open(link);
		}
		
		function chars() {
			var codelen = document.getElementById("code").value.length;
			document.getElementById("ccount").innerHTML = codelen;
		}

		function clearText() {
			document.getElementById("code").value = "";
			document.getElementById("output").value = "";

			chars();
		}

		function getURLParameter(name) {
			return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [null, ''])[1].replace(/\+/g, '%20')) || null;
		}
		
		var rcode = getURLParameter("code");
		
		if (rcode !== null) {
			document.getElementById("code").value = decode(rcode);
		}

		chars();

		// INTERPRETER CODE STARTS
		
		var code, accumulator, position;
		var ifstage, testval, test;
		var tempaccumulator, temppos;
		var output, variables, funcpos;
		var functions;
		var funccode;
		
		function check() {
			if (code[position] == "^") {
				accumulator += 1;
				position += 1;
			} else if (code[position] == "v") {
				accumulator -= 1;
				position += 1;
			} else if (code[position] == "a") {
				output += String.fromCharCode(accumulator);
				position += 1;
			} else if (code[position] == "o") {
				output += accumulator;
				position += 1;
			} else if (code[position] == "r") {
				accumulator = Math.round(Math.random()*accumulator);
				position += 1;
			} else if ("0123456789".indexOf(code[position]) !== -1) {
				try {
					n = ""
					while ("0123456789".indexOf(code[position]) !== -1) {
						n += code[position];
						position += 1;
					}
					accumulator = Number(n);
				} catch(e) {
					accumulator = Number(n);
				}
			} else if (code[position] == "~") {
				if ("(){}+-naod@;|r~*/%I<>=^v".indexOf(code[position+1]) === -1) {
					variables[code[position+1]] = accumulator;
					position += 2;
				} else {
					// raise Name Error
					document.getElementById("output").style.color = "red";
					output = "Name Error: " + code[position+1] + " at position " + (position+1) + " is a reserved keyword";
					position = code.length * 2;
				}
            } else if (code[position] == "(") {
				tempaccumulator.push(accumulator);
				temppos.push(position + 1);
				accumulator = 0;
				position += 1;
			} else if (code[position] == ")") {
				if (accumulator == tempaccumulator[tempaccumulator.length-1]) {
					position += 1;
					tempaccumulator.pop();
					temppos.pop();
				} else {
					position = temppos[temppos.length-1];
				}
			} else if (code[position] == "{") {
				if (ifstage == 1) {
					testval = accumulator;
					accumulator = 0;
					position += 1;
				} else if (ifstage == 2) {
					if (!test) {
						try {
							while (code[position] != "}") {
								position += 1;
							}
							accumulator = testval;
						} catch(e) {
							// Do nothing
						}
					} else {
						position += 1;
					}
				}
				
			} else if (code[position] == "}") {
				if (ifstage == 1) {
					ifstage = 2
					if (accumulator == testval) {
						test = true;
					} else {
						test = false;
					}
					position += 1;
				} else if (ifstage == 2) {
					ifstage = 1;
					testval = 0;
					test = true;
				
					position += 1;
				}
			
			} else if(code[position] == "|") {
				position += 1;
				var tempfcode = "";
				while (code[position] != "|") {
					tempfcode += code[position];
					position += 1;
				}
				position += 2;
				functions[code[position-1]] = tempfcode;
				
			} else if (code[position] == " ") {
				position += 1
			} else if (code[position] == "*") {
				position += 1;
				multitempaccumulator = accumulator;
				check();
				accumulator *= multitempaccumulator;
			} else if (code[position] == "/") {
				position += 1;
				divtempaccumulator = accumulator;
				check();
				accumulator = Math.floor(divtempaccumulator/accumulator);
			} else if (code[position] == "%") {
				position += 1;
				modtempaccumulator = accumulator;
				check();
				accumulator = modtempaccumulator % accumulator;
			} else if (code[position] == "+") {
				position += 1;
				addtempaccumulator = accumulator;
				check();
				accumulator += addtempaccumulator;
			} else if (code[position] == "-") {
				position += 1;
				subtempaccumulator = accumulator;
				check();
				accumulator = subtempaccumulator - accumulator;
			} else if (code[position] == "I") {
				var stdin = prompt("Enter input:");
				if (stdin !== "") {
					try {
						stdin = Number(stdin);
					} catch(e) {
						stdin = stdin.charCodeAt(0);
					}
					accumulator = stdin;
				}
				position += 1
			} else if (code[position] == ">") {
				position += 1;
				gttempaccumulator = accumulator;
				check();
				if (gttempaccumulator > accumulator) {
					accumulator = 1;
				} else {
					accumulator = 0;
				}
			} else if (code[position] == "<") {
				position += 1;
				lttempaccumulator = accumulator;
				check();
				if (lttempaccumulator < accumulator) {
					accumulator = 1;
				} else {
					accumulator = 0;
				}
			} else if (code[position] == "=") {
				position += 1;
				eqtempaccumulator = accumulator;
				check();
				if (eqtempaccumulator == accumulator) {
					accumulator = 1;
				} else {
					accumulator = 0;
				}
			} else if (code[position] == "d") {
				var date = new Date();
				if (accumulator === 0) {
					accumulator = date.getSeconds();
				} else if (accumulator == 1) {
					accumulator = date.getMinutes();
				} else if (accumulator == 2) {
					accumulator = date.getHours();
				} else if (accumulator == 3) {
					accumulator = date.getDate();
				} else if (accumulator == 4) {
					accumulator = date.getMonth();
				} else if (accumulator == 5) {
					accumulator = date.getFullYear();
				} else {
					accumulator = date.getTime();
				}

				position += 1;
			} else if (code[position] == "@") {
				output = "";
				position += 1;
			} else if (code[position] == ";") {
				var delay = accumulator;
				var delaypos = position+1;
				setTimeout(function(){position = delaypos;runCode();}, delay*1000);
				return code.length*2;
			} else {
				if (functions.hasOwnProperty(code[position])) {
					funcpos.push(position);
					funccode.push(code);
					
					code = functions[code[position]]
					position = 0;
					
					console.log(funcpos);
					console.log(funccode);
					console.log(code);
					
					while(position < code.length){
						position = check();
						console.log(code[position]);
					}
					
					code = funccode.pop();
					position = funcpos.pop()+1;
					console.log(position+"\n\n");
					
				} else if (variables.hasOwnProperty(code[position])) {
					accumulator = variables[code[position]];
					position += 1;
				} else {
					variables[code[position]] = 0;
					accumulator = 0;
					position += 1;
				}
			}
			document.getElementById("output").value = output;
			return position;
		}

		function runCode() {
			while(position < code.length){
				position = check();
			}
			console.log(position);
		}
		
		function main() {
			code = document.getElementById("code").value;
			position = 0;
			accumulator = 0;
			
			ifstage = 1;
			testval = 0;
			test = true;

			output = "";
			
			document.getElementById("output").value = output;
			document.getElementById("output").style.color = "black";
			
			tempaccumulator = [];
			temppos = [];
			
			functions = {};
			funcpos = [];
			funccode = [];
			
			variables = {};
			
			runCode();
			
			document.getElementById("output").value = output;
		}	
	</script>
</body>
</html>
